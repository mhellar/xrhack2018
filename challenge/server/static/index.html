<html>

<head>
    <meta charset="utf-8">
    <title>Mind Palace - WebXR Weekend Challenge 2018</title>
    <meta name="description" content="Mind Palace - WebXR Weekend Challenge 2018">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="/js/aframe-master.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script>
        window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')
    </script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>

    <script src="https://mmullen200.github.io/components.js"></script>

    <script src="/dist/aframe-teleport-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-input-mapping-component/dist/aframe-input-mapping-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>
    <script src="/common/mappings.js"></script>

</head>

<body>
    <script>
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            // js.src = "https://connect.facebook.net/en_US/sdk/debug.js";
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
    <a-scene networked-scene="
      room: handcontrollers;
      debug: true;
    ">
        <a-assets>
            <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
            <img id="sky" src="https://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />

            <a-asset-item id="temple" src="assets/temple_environment/scene.gltf"></a-asset-item>
            <a-asset-item id="bonnie" src="assets/bonnie/scene.gltf"></a-asset-item>        
            <a-asset-item id="spaceinvader" src="assets/space_invader.obj"></a-asset-item>
            <a-asset-item id="spaceinvader-mtl" src="assets/space_invader.mtl"></a-asset-item>
            <a-asset-item id="spaceinvader2" src="assets/space_invader2.obj"></a-asset-item>
            <a-asset-item id="spaceinvader2-mtl" src="assets/space_invader2.mtl"></a-asset-item>
            <a-asset-item id="spaceinvader3" src="assets/space_invader3.obj"></a-asset-item>
            <a-asset-item id="spaceinvader3-mtl" src="assets/space_invader3.mtl"></a-asset-item>

            <!-- Templates -->

            <!-- Player -->
            <template id="player-template">
              <a-entity></a-entity>
            </template>

            <!-- Head -->
            <template id="head-template">
              <a-entity class="avatar">
                <a-sphere class="head"
                  color="#ffffff"
                  scale="0.45 0.5 0.4"
                ></a-sphere>
                <a-entity class="face"
                  position="0 0.05 0"
                >
                  <a-sphere class="eye"
                    color="#efefef"
                    position="0.16 0.1 -0.35"
                    scale="0.12 0.12 0.12"
                  >
                    <a-sphere class="pupil"
                      color="#000"
                      position="0 0 -1"
                      scale="0.2 0.2 0.2"
                    ></a-sphere>
                  </a-sphere>
                  <a-sphere class="eye"
                    color="#efefef"
                    position="-0.16 0.1 -0.35"
                    scale="0.12 0.12 0.12"
                  >
                    <a-sphere class="pupil"
                      color="#000"
                      position="0 0 -1"
                      scale="0.2 0.2 0.2"
                    ></a-sphere>
                  </a-sphere>
                </a-entity>
              </a-entity>
            </template>

            <!-- Hand -->
            <template id="hand-template">
              <a-entity>
              </a-entity>
            </template>

            <template id="photo-template">
              <a-entity>
                <a-image class="photo"></a-image>
              </a-entity>
            </template>
        </a-assets>

        <a-entity gltf-model="#temple" position="0 1.5 0" scale="0.03, 0.03, 0.03"></a-entity>

        <a-entity static-body obj-model="obj: #spaceinvader; mtl: #spaceinvader-mtl" position="-10 3 0"></a-entity>
        <a-entity static-body obj-model="obj: #spaceinvader2; mtl: #spaceinvader2-mtl" position="4 3 0"></a-entity>
        <a-entity static-body obj-model="obj: #spaceinvader3; mtl: #spaceinvader3-mtl" position="8 3 0"></a-entity>

        <a-entity id="player" networked="template:#player-template;attachTemplateToLocal:false;" spawn-in-circle="radius:3" wasd-controls>
            <a-entity camera="userHeight: 1.6" wasd-controls look-controls networked="template:#head-template;attachTemplateToLocal:false;">
                <a-sphere class="head" random-color visible="false"></a-sphere>
            </a-entity>
            <a-entity networked="template:#hand-template;" id="rightHand" mixin="teleport" laser-controls="hand: right" microsoft-motion-controls="hand: right" oculus-go-controls="hand: right"></a-entity>
            <a-mixin id="teleport" teleport-controls="type: parabolic; cameraRig: #player; collisionEntities: [mixin='box'],[mixin='sphere']"></a-mixin>
        </a-entity>

        <a-entity position="0 0 0" geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0" material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

        <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
        <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

        <a-sky src="#sky" rotation="0 -90 0"></a-sky>
    </a-scene>

    <script>
        // On mobile remove elements that are resource heavy
        var isMobile = AFRAME.utils.device.isMobile();

        if (isMobile) {
            var particles = document.getElementById('particles');
            particles.parentNode.removeChild(particles);
        }
    </script>

    <script>
        // Define custom schema for syncing avatar color, set by random-color
        NAF.schemas.add({
            template: '#head-template',
            components: [
                'position',
                'rotation', {
                    selector: '.head',
                    component: 'material'
                }
            ]
        });

        NAF.schemas.add({
            template: '#player-template',
            components: [
                'position',
                'rotation'
            ]
        });

        NAF.schemas.add({
            template: '#hand-template',
            components: [
                'position',
                'rotation'
            ]
        });

        NAF.schemas.add({
            template: '#photo-template',
            components: [
                'position',
                'rotation', {
                    selector: '.photo',
                    component: 'material',
                    property: 'src'
                }
            ]
        });

        // Called by Networked-Aframe when connected to server
        function onConnect() {
            console.log("onConnect");
        }
    </script>
    <div id="loader">
        <p>Please wait...</p>
        <div class="fb-login-button" data-scope="public_profile,user_photos" data-onlogin="checkFBLoginState();" data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="false" data-use-continue-as="true"></div>
        <button onclick="skip();">Skip</button>
        <div style="display:none;" class="fb-logout-button"><button onclick="logout();">Logout</button></div>
    </div>
    <script src="/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/js/facebook.js"></script>
</body>

</html>