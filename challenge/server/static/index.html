<html>

<head>
    <meta charset="utf-8">
    <title>Mind Palace - WebXR Weekend Challenge 2018</title>
    <meta name="description" content="Mind Palace - WebXR Weekend Challenge 2018">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="/js/aframe-master.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script>
        window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')
    </script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>

    <script src="https://mmullen200.github.io/components.js"></script>

    <script src="/dist/aframe-teleport-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-input-mapping-component/dist/aframe-input-mapping-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="/common/mappings.js"></script>

    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v2.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <script src="/dist/super-hands.min.js"></script>

</head>

<body>
    <script>
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            // js.src = "https://connect.facebook.net/en_US/sdk/debug.js";
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        AFRAME.registerComponent('color-randomizer', {
            play: function() {
                this.el.addEventListener('drag-drop', function(evt) {
                    evt.detail.dropped.setAttribute('material', 'color', '#' + (Math.random() * 0xFFFFFF <<
                        0).toString(16)); // color randomizer credit: http://stackoverflow.com/questions/1484506/random-color-generator-in-javascript#comment6801353_5365036
                });
            }
        }); // turn controller 's physics presence on only while button held down
        AFRAME.registerComponent('phase-shift ', {
            init: function() {
                var el = this.el;
                el.addEventListener('gripdown ', function() {
                    el.setAttribute('collision-filter ', {
                        collisionForces: true
                    });
                });
                el.addEventListener('gripup ', function() {
                    el.setAttribute('collision-filter ', {
                        collisionForces: false
                    });
                });
            }
        });
    </script>
    <a-scene networked-scene="
      room: handcontrollers;
      debug: true;
 " physics environment="preset: tron; shadow: true">

        <a-assets>

            <a-entity position="0 1 1">
                <a-plane src="#ground" height="100" width="100" rotation="0 0 0"></a-plane>
            </a-entity>

            <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
            <img id="sky" src="http://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />

            <a-asset-item id="spaceinvader" height="100" width="100" src="assets/space_invader.obj"></a-asset-item>
            <a-asset-item id="spaceinvader-mtl" src="assets/space_invader.mtl"></a-asset-item>
            <a-asset-item id="spaceinvader2" src="assets/space_invader2.obj"></a-asset-item>
            <a-asset-item id="spaceinvader2-mtl" src="assets/space_invader2.mtl"></a-asset-item>
            <a-asset-item id="spaceinvader3" src="assets/space_invader3.obj"></a-asset-item>
            <a-asset-item id="spaceinvader3-mtl" src="assets/space_invader3.mtl"></a-asset-item>

            <a-mixin id="cube" geometry="primitive: box; width: 0.33; height: 0.33; depth: 0.33" hoverable grabbable stretchable draggable event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true" event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
                event-set__dragon="_event: dragover-start; wireframe: true" event-set__dragoff="_event: dragover-end; wireframe: false" dynamic-body shadow></a-mixin>
            <a-mixin id="transformer" color-randomizer droppable static-body collision-filter="collisionForces: false" geometry="primitive: box; width: 0.5; height: 0.5; depth: 0.5"></a-mixin>
            <!-- to customize gaze cursor appearance. must list all components
             because override property is set on progressive-controls -->
            <a-mixin id="mycursor" position="0 0 -0.5" raycaster geometry="primitive: ring; radiusOuter: 0.008; radiusInner: 0.005; segmentsTheta: 32" material="color: white; shader: flat" static-body="shape: sphere; sphereRadius: 0.001" super-hands="colliderEvent: raycaster-intersection;
                              colliderEventProperty: els;
                              colliderEndEvent:raycaster-intersection-cleared;
                              colliderEndEventProperty: clearedEls;
                              colliderState:"></a-mixin>
            <!-- to change touch mode collider -->
            <a-mixin id="mytouch" physics-collider phase-shift collision-filter="collisionForces: false" static-body="shape: sphere; sphereRadius: 0.02" super-hands="colliderEvent: collisions; colliderEventProperty: els;
                              colliderEndEvent: collisions; colliderEndEventProperty: clearedEls;
                              colliderState:"></a-mixin>

            <!-- Templates -->

            <!-- Player -->
            <template id="player-template">
              <a-entity></a-entity>
            </template>

            <!-- Head -->
            <template id="head-template">
              <a-entity class="avatar">
                <a-sphere class="head"
                  color="#ffffff"
                  scale="0.45 0.5 0.4"
                ></a-sphere>
                <a-entity class="face"
                  position="0 0.05 0"
                >
                  <a-sphere class="eye"
                    color="#efefef"
                    position="0.16 0.1 -0.35"
                    scale="0.12 0.12 0.12"
                  >
                    <a-sphere class="pupil"
                      color="#000"
                      position="0 0 -1"
                      scale="0.2 0.2 0.2"
                    ></a-sphere>
                  </a-sphere>
                  <a-sphere class="eye"
                    color="#efefef"
                    position="-0.16 0.1 -0.35"
                    scale="0.12 0.12 0.12"
                  >
                    <a-sphere class="pupil"
                      color="#000"
                      position="0 0 -1"
                      scale="0.2 0.2 0.2"
                    ></a-sphere>
                  </a-sphere>
                </a-entity>
              </a-entity>
            </template>

            <!-- Hand -->
            <template id="hand-template">
              <a-entity>
                <!-- <a-box scale="0.1 0.1 0.1"></a-box> -->
              </a-entity>
            </template>

            <template id="photo-template">
              <a-entity>
                <a-image class="photo"></a-image>
              </a-entity>
            </template>

            <!-- /Templates -->
        </a-assets>

        <a-entity static-body obj-model="obj: #spaceinvader; mtl: #spaceinvader-mtl" position="-10 3 0"></a-entity>
        <a-entity static-body obj-model="obj: #spaceinvader2; mtl: #spaceinvader2-mtl" position="4 3 0"></a-entity>
        <a-entity static-body obj-model="obj: #spaceinvader3; mtl: #spaceinvader3-mtl" position="8 3 0"></a-entity>

        </a-entity>
        <a-entity class="cube" mixin="cube" position="0 0.265 1" material="color: red"></a-entity>
        <a-entity class="cube" mixin="cube" position="0 0.265 1" material="color: red"></a-entity>
        <a-entity class="cube" mixin="cube" position="-1 0.265 1" material="color: blue"></a-entity>
        <a-entity class="cube" mixin="cube" position="-1 0.265 1" material="color: blue"></a-entity>
        <a-entity class="cube" mixin="cube" position="1 0.265 1" material="color: green"></a-entity>
        <a-entity class="cube" mixin="cube" position="1 0.265 1" material="color: green"></a-entity>
        <a-entity class="transformer" mixin="transformer" position="0 1.6 -1" material="src:#colortransform" shadow>
        </a-entity>
        <a-box static-body width=100 height=0.001 depth=100 visible="false"></a-box>

        <a-entity id="player" networked="template:#player-template;attachTemplateToLocal:false;" spawn-in-circle="radius:3" wasd-controls>
            <a-entity camera="userHeight: 1.6" wasd-controls look-controls networked="template:#head-template;attachTemplateToLocal:false;">
                <a-sphere class="head" random-color visible="false"></a-sphere>
            </a-entity>
            <a-entity progressive-controls="gazeMixin: mycursor; touchMixin: mytouch; override: true"></a-entity>
            <a-entity networked="template:#hand-template;" id="rightHand" mixin="teleport" laser-controls="hand: right" microsoft-motion-controls="hand: right" oculus-go-controls="hand: right"></a-entity>

            <a-mixin id="teleport" teleport-controls="type: parabolic; cameraRig: #player; collisionEntities: [mixin='box'],[mixin='sphere']"></a-mixin>
        </a-entity>

        <a-entity position="0 0 0" geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0" material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

        <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
        <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

        <a-sky src="#sky" rotation="0 -90 0"></a-sky>
    </a-scene>

    <script>
        // On mobile remove elements that are resource heavy
        var isMobile = AFRAME.utils.device.isMobile();

        if (isMobile) {
            var particles = document.getElementById('particles');
            particles.parentNode.removeChild(particles);
        }
    </script>

    <script>
        // Define custom schema for syncing avatar color, set by random-color
        NAF.schemas.add({
            template: '#head-template',
            components: [
                'position',
                'rotation', {
                    selector: '.head',
                    component: 'material'
                }
            ]
        });

        NAF.schemas.add({
            template: '#player-template',
            components: [
                'position',
                'rotation'
            ]
        });

        NAF.schemas.add({
            template: '#hand-template',
            components: [
                'position',
                'rotation'
            ]
        });

        NAF.schemas.add({
            template: '#photo-template',
            components: [
                'position',
                'rotation', {
                    selector: '.photo',
                    component: 'material',
                    property: 'src'
                }
            ]
        });

        // Called by Networked-Aframe when connected to server
        function onConnect() {
            console.log("onConnect");
        }
    </script>
    <div id="loader">
        <p>Please wait...</p>
        <div class="fb-login-button" data-scope="public_profile,user_photos" data-onlogin="checkFBLoginState();" data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="false" data-use-continue-as="true"></div>
        <button onclick="skip();">Skip</button>
        <div style="display:none;" class="fb-logout-button"><button onclick="logout();">Logout</button></div>
    </div>
    <script src="/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/js/facebook.js"></script>
</body>

</html>
